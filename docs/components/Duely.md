# Duely

## Описание

- Единственная входная точка для пользователя.
- Хранение пользователей, рейтинга.
- Подбор соперника для дуэли.
- Управление дуэлями.
- Выдача id задачи для дуэли.
- Выдача информации про дуэль.
- Контроль за правилами и временем дуэли.
- Инициирование проверки решения.
- Хранение посылок участника дуэли.
- Получение вердикта.
- Завершение и формирование результата дуэли.
- Пересчёт рейтинга участников.
- Выдача истории дуэлей пользователя.

## Домен

### Сущности

- Пользователь:
    - id
    - ник
    - рейтинг
- Дуэль:
    - id
    - два пользователя
    - время начала, максимальная продолжительность, время реального конца
    - задача
    - результат (кто выиграл либо ничья)
    - изменение рейтинга пользователей
    - посылки пользователей
- Посылка:
    - id
    - пользователь
    - дуэль
    - время отправки
    - код, язык
    - текущий статус
    - вердикт тестирования

### Процессы

- Пользователь встаёт в очередь ожидания дуэли
- Пользователь выходит из очереди ожидания дуэли
- Система определяет двух участников и начинает дуэль
- Пользователь отправляет посылку на тестирование
- Система получает обновление статуса либо вердикт тестирования посылки
- Система заканчивает дуэль
- Пользователь смотрит историю своих дуэлей
- Пользователь смотрит одну из своих дуэлей

## Интеграция

- Пользователь встаёт в очередь ожидания дуэли
    - фронтенд делает запрос на установку WS соединения
- Пользователь выходит из очереди ожидания дуэли
    - фронтенд обрывает WS соединение
- Система определяет двух участников и начинает дуэль
    - бэкенд отправляет в WS сообщение о начале дуэли
    - фронтенд делает HTTP GET запрос дуэли
- Пользователь отправляет посылку на тестирование
    - фронтенд отправляет посылку в WS
    - бэкенд отправляет в WS сообщение о создании посылки
- Система получает обновление статуса либо вердикт тестирования посылки
    - бэкенд отправляет в WS сообщение об обновлении статуса или вердикте тестирования посылки
- Система заканчивает дуэль
    - бэкенд отправляет обоим пользователям в WS сообщение о завершении дуэли

## API

### WebSocket API

ws://localhost:5001/ws?user_id=1

#### Сообщения от клиента

Присоединиться к дуэли
```json
{ "action": "join" }
```

Отправить решение
```json
{
    "action": "submit",
    "submission_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "solution": "print(sum(map(int, input().split())))",
    "language": "Python",
}
```

#### Сообщения от сервера

Дуэль стартовала, выдан task_id
```json
{
    "type": "duel_started",
    "duel_id": "123",
}
```

Подтверждение, что решение добавлено в очередь
```json
{
    "type": "submisson_received",
    "submission_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479", 
}
```

Обновление вердикта посылки

Промежуточный результат тестирования
```json
{
    "type": "submisson_update",
    "submission_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "status": "Test #2 passed"
}
```

Финальный вердикт
```json
{
    "type": "submisson_verdict",
    "submission_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "verdict": "Accepted", // Или "Wrong Answer on test #3", "Time Limit Exceeded", "Compilation Error"
}
```

Завершение дуэли
```json
{
    "type": "duel_finished",
    "winner": "1", // Или "2", "draw"
}
```

### HTTP API

Получить информацию о дуэли
GET /api/duels/{duel_id}

```json
{
    "id": "123",
    "status": "in_progress",
    "task_id": "4cf94aac-ae47-459b-bb6a-459784fecc66",
    "starts_at": "2025-09-16T00:25:00Z",
    "deadline_at": "2025-09-16T00:55:00Z"
}
```

Получить список посылок игрока
GET /api/duels/{duel_id}/submissions

```json
[
    {
        "submission_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
        "status": "finished",
        "verdict": "Wring Answer on test #2",
        "created_at": "2025-09-17T14:05:00Z"
    },
    {
        "submission_id": "d9428888-1223-4e89-bcd7-891a2c3f4a5d",
        "status": "finished",
        "verdict": "Accepted",
        "created_at": "2025-09-17T14:12:00Z"
    }
]
```

Получить посылку детально
GET /api/duels/{duel_id}/submissions/{submission_id}

```json
{
    "submission_id": "123",
    "solution": "print(sum(map(int, input().split())))",
    "language": "Python",
    "status": "finished",
    "verdict": "Accepted",
    "created_at": "2025-09-17T14:12:00Z"
}
```

## Схема данных
### duels
| Поле          | Тип        | Описание                             |
|---------------|------------|--------------------------------------|
| id            | serial PK  | id дуэли                             |
| task_id       | text       | id задачи (внешний, из Taski)        |
| user1_id      | int        | id первого участника                 |
| user2_id      | int        | id второго участника                 |
| status        | text       | Признак завершения дуэли             |
| result        | varchar(8) | Результат: draw / user1 / user2      |
| max_duration  | interval   | Макс. продолжительность(дефол 30)    |
| start_time    | timestamp  | Время начала                         |
| end_time      | timestamp  | Время окончания                      |


### submissions
| Поле        | Тип        | Описание                               |
|-------------|------------|----------------------------------------|
| id          | serial PK  | id посылки                             |
| duel_id     | int FK     | Ссылка на дуэль                        |
| user_id     | int        | id пользователя (user_id)              |
| code        | text       | Код решения                            |
| language    | text       | Язык                                   |
| submit_time | timestamp  | Время отправки                         |
| status      | text       | queued / running / done                |
| verdict     | text       | OK/TLE/WA                              |

### связи
- **duels** ──< **submissions** (одна дуэль содержит много посылок)
- `duels.task_id` →  **Taski** 

### Картинка
диаграмма по [ссылке](https://dbdiagram.io/e/68bb1a3d61a46d388ead2b84/68caa2775779bb7265e3ce14) специально темная тема :)
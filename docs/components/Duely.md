# Duely

## Описание

- Единственная входная точка для пользователя.
- Хранение пользователей, рейтинга.
- Подбор соперника для дуэли.
- Управление дуэлями.
- Выдача id задачи для дуэли.
- Выдача информации про дуэль.
- Контроль за правилами и временем дуэли.
- Инициирование проверки решения.
- Хранение посылок участника дуэли.
- Получение вердикта.
- Завершение и формирование результата дуэли.
- Пересчёт рейтинга участников.
- Выдача истории дуэлей пользователя.

## Домен

### Сущности

- Пользователь:
    - id
    - ник
    - рейтинг
- Дуэль:
    - id
    - два пользователя
    - время начала, максимальная продолжительность, время реального конца
    - задача
    - результат (кто выиграл либо ничья)
    - изменение рейтинга пользователей
    - посылки пользователей
- Посылка:
    - id
    - пользователь
    - дуэль
    - время отправки
    - код, язык
    - текущий статус
    - вердикт тестирования

### Процессы

- Пользователь встаёт в очередь ожидания дуэли
    - делает запрос типа ws://localhost:5001/ws?user_id=1
    - в этот момент устанавливается ws соединение, чтобы система имела возможность оповестить пользователя о начале дуэли
    - ws соединения хранятся в памяти программы
    - пользователь попадает очередь ожидания, находящуюся в памяти программы
- Пользователь выходит из очереди ожидания дуэли
    - обрывает ws соединение
    - удалить ws соединение из пямяти программы
    - пользователь убирается из очереди ожидания, находящейся в памяти программы
- Система определяет двух участников и начинает дуэль
    - background процесс, который регулярно смотрит на пользователей, находящихся в ожидании дуэли, и исходя их некоторых параметров создаёт дуэли
    - найти задачу, для чего система идёт в Taski
    - вычислить максимальную продолжительность дуэли (по дефолту 30 минут)
    - сохранить дуэль в БД
    - отправить в ws сообщение о начале дуэли id (через паттерн outbox)
    - пользователь должен будет сделать HTTP GET запрос на получение дуэли
- Пользователь отправляет посылку на тестирование
    - пользователь отправляет посылку в ws
    - система создаёт посылку и сохраняет в БД
    - отправляет в ws сообщение о создании посылки (через паттерн outbox)
    - background процесс, который регулярно смотрит на посылки, выбирает новые и отправляет запрос на тестирование в Taski - после этого меняет статус
- Система получает обновление статуса либо вердикт тестирования посылки
    - получает из Kafka
    - система сохраняет обновление в БД
    - отправляет в ws сообщение об обновлении статуса или вердикте тестирования посылки (через паттерн outbox)
- Система заканчивает дуэль
    - background процесс, который регулярно смотрит на дуэли, посылки пользователей, вердикты тестирования
    - если выполняется условие окончания дуэли, вычисляет результат дуэли, а также изменение рейтинга, и обновляет запись в бд
    - отправляет обоим пользователям в ws сообщение о завершении дуэли (через паттерн outbox)
- Пользователь смотрит историю своих дуэлей
    - сходить в БД и взять все дуэли пользователя
- Пользователь смотрит одну из своих дуэлей
    - сходить в БД, взять дуэль и все посылки пользователя по этой дуэли
- Отправка сообщения пользователю в ws через паттерн outbox:
    - в БД есть специальная таблица outbox, которая хранит в себе все сообщения, которые надо отправить пользователю
    - background процесс смотрит на эти сообщения, берёт очередное ещё не отправленное и пытается отправить

## API
TODO

## Схема данных
TODO

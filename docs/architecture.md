# Архитектура

## Компоненты

<img src="architecture.jpg" width="800px" alt="https://miro.com/app/board/uXjVJcoEORo=/">

Система построена по микросервисной архитектуре и состоит из трёх ключевых компонентов:
1. Duely - управление пользователями и дуэлями.
2. Taski - хранение задач и управление проверкой решений.
3. Exesh - тестирование задач и выполнение кода.

### [Duely](components/Duely.md)

- Единственная входная точка для пользователя.
- Хранение пользователей, рейтинга.
- Подбор соперника для дуэли.
- Управление дуэлями.
- Выдача задачи для дуэли.
- Выдача информации про дуэль.
- Контроль за правилами и временем дуэли.
- Инициирование проверки решения.
- Хранение посылок участника дуэли.
- Получение вердикта.
- Завершение и формирование результата дуэли.
- Пересчёт рейтинга участников.
- Выдача истории дуэлей пользователя.

### [Taski](components/Taski.md)

- Хранение задач.
- Выдача информации по задаче пользователю для решения.
- Выдача файла задачи по запросу (например, условие / тесты).
- Выдача полного архива с задачей для тестирования.
- Проверка решения задачи, выдача вердикта тестирования.

### [Exesh](components/Exesh.md)

- Запуск списка шагов для тестирования задачи.
- Запуск кода пользователя на входных данных и выдача выходных данных.

## Взаимодействие компонентов

### Получение задачи
```mermaid
sequenceDiagram
    participant Client
    participant Taski

    Client->>Taski: Дай мне информацию по задаче для решения
    Taski->>Client: Получай информацию по задаче
    Client->>Taski: Дай файл statement.tex из задачи
    Taski->>Client: Получай файл statement.tex
```

### Тестирование задачи
```mermaid
sequenceDiagram
    participant Client
    participant Duely
    participant Kafka1
    participant Taski
    participant Kafka2
    participant Exesh

    Client->>Duely: Послать решение задачи на проверку
    Duely->>Client: Ок, решение проверяется, получайте обновления статуса
    Duely->>Taski: Протестировать решение пользователя
    Taski->>Duely: Ок, протестируем, следите за обновлениями статуса
    Duely->>Kafka1: Подписаться на обновление статуса
    Taski->>Exesh: Запустить список шагов тестирования
    Exesh->>Taski: Ок, сделаем, следите за обновлениями статуса
    Taski->>Kafka2: Подписаться на обновление статуса

    Exesh->>Kafka2: Обновление статуса (начинаем выполнение)
    Kafka2-->>Taski: Получайте обновление статуса
    Taski->>Kafka1: Обновление статуса (тестирование начали)
    Kafka1-->>Duely: Получайте обновление статуса
    Duely->>Client: Обновление статуса (тестирование начали)

    loop Тестирование
        Exesh->>Exesh: Выполнение одного шага
        Exesh->>Kafka2: Обновление статуса (шаг выполнен)
        Kafka2-->>Taski: Получайте обновление статуса
        Taski->>Kafka1: Обновление статуса (тестирование в процессе)
        Kafka1-->>Duely: Получайте обновление статуса
        Duely->>Client: Обновление статуса (тестирование в процессе)
    end

    Exesh->>Kafka2: Обновление статуса (все шаги выполнены)
    Kafka2-->>Taski: Получайте обновление статуса
    Taski->>Kafka1: Обновление статуса (тестирование окончено)
    Kafka1-->>Duely: Получайте обновление статуса
    Duely->>Client: Обновление статуса (тестирование окончено)
```

### Запуск кода пользователя на входных данных
```mermaid
sequenceDiagram
    participant Client
    participant Duely
    participant Kafka
    participant Exesh

    Client->>Duely: Запустить код пользователя на входных данных
    Duely->>Client: Ок, запускаем код, получайте обновления статуса
    Duely->>Exesh: Запустить список шагов запуска кода
    Exesh->>Duely: Ок, сделаем, следите за обновлениями статуса
    Duely->>Kafka: Подписаться на обновление статуса

    Exesh->>Kafka: Обновление статуса (выполнение начали)
    Kafka-->>Duely: Получайте обновление статуса
    Duely->>Client: Обновление статуса (выполнение начали)

    loop Выполнение кода
        Exesh->>Exesh: Выполнение одного шага
        Exesh->>Kafka: Обновление статуса (шаг выполнен)
        Kafka-->>Duely: Получайте обновление статуса
        Duely->>Client: Обновление статуса (выполнение кода в процессе)
    end

    Exesh->>Kafka: Обновление статуса (все шаги выполнены)
    Kafka-->>Duely: Получайте обновление статуса
    Duely->>Client: Обновление статуса (выполнение кода окончено)
```

## Деплоймент

<img src="deployment.png" width="800px">
